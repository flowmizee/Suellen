<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat com Suellen</title>
    <style>
        :root {
            --primary-color: #25D366;
            --secondary-color: #128C7E;
            --dark-color: #075E54;
            --light-color: #DCF8C6;
            --white: #FFFFFF;
            --gray: #ECE5DD;
            --dark-gray: #667781;
            --error-color: #FF3B30;
            --success-color: #34C759;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--gray);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .chat-container {
            width: 100%;
            max-width: 450px;
            height: 100vh;
            background-color: var(--white);
            display: flex;
            flex-direction: column;
            box-shadow: 0 1px 10px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .chat-header {
            background-color: var(--dark-color);
            color: var(--white);
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .header-info h2 {
            font-size: 16px;
            font-weight: 600;
        }

        .header-info p {
            font-size: 12px;
            opacity: 0.8;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: var(--gray);
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAABmJLR0QA/wD/AP+gvaeTAAAA+UlEQVQ4y+3UMUoDQRTG8Z8psJBUKTyAR7ATvIBgYSM2Fh7AG3gBG0GxECwELQJik1qwsBAkEIuQZLGwsJj3LDOw7CabTbzwYJh5M9/7Zpg3Q6VSqfQf1cMq9vGCN7zjCQ+4xW2RcIh7fOITL3jGMx7xiHvc4BqX2M0TDnCHL3zjK1Nf+MAn3nGNCQZZwj4u8I5xgegYI1xiJ0vYxQhvBcI8jXGOrSzhBq4KRP9qiPUs4RouCkT/6gJrWcIlnBeI/tUZFrOECzjLEf2rU8xnCedxkiP6V8eYyxLO4ShH9K8OMZMlnMZ+jmhSe5jKEk5hL0c0qV1MZgkT7OSIJrWNiSxhnG1sZYkmtYmxLGGMTWxkiSa1jv+JfgCJ5DfAoYx1jAAAAABJRU5ErkJggg==');
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .message {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
            position: relative;
        }

        .message.user {
            background-color: var(--light-color);
            align-self: flex-end;
            border-bottom-right-radius: 0;
        }

        .message.bot {
            background-color: var(--white);
            align-self: flex-start;
            border-bottom-left-radius: 0;
        }

        .message img {
            max-width: 100%;
            border-radius: 5px;
            margin-top: 5px;
        }

        .typing-indicator {
            background-color: var(--white);
            padding: 8px 12px;
            border-radius: 8px;
            align-self: flex-start;
            display: inline-flex;
            gap: 4px;
        }

        .typing-indicator span {
            width: 6px;
            height: 6px;
            background-color: var(--dark-gray);
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .chat-input-area {
            padding: 10px;
            background-color: var(--white);
            border-top: 1px solid #ddd;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            background-color: var(--gray);
            font-size: 14px;
            outline: none;
        }

        .send-button {
            width: 40px;
            height: 40px;
            background-color: var(--primary-color);
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .send-button:hover {
            background-color: var(--secondary-color);
        }

        .attachment-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
        }

        .pix-upload-area {
            display: none;
            padding: 15px;
            background-color: var(--white);
            border-top: 1px solid #ddd;
            flex-direction: column;
            gap: 10px;
        }

        .preview-container {
            max-height: 200px;
            overflow: hidden;
            border-radius: 8px;
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .preview-container img {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
        }

        .preview-container canvas {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
        }

        .upload-buttons {
            display: flex;
            gap: 10px;
        }

        .upload-button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: var(--primary-color);
            color: var(--white);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .upload-button:hover {
            background-color: var(--secondary-color);
        }

        .status-message {
            font-size: 12px;
            text-align: center;
            color: var(--dark-gray);
        }

        .error-message {
            color: var(--error-color);
            font-weight: 500;
        }

        .success-message {
            color: var(--success-color);
            font-weight: 500;
        }

        .pix-info {
            background-color: #f0f0f0;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 13px;
        }

        .pix-info p {
            margin: 5px 0;
        }

        .action-button {
            background-color: var(--dark-color);
            color: var(--white);
            border: none;
            border-radius: 20px;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
            align-self: center;
        }

        .action-button:hover {
            background-color: #054d43;
        }

        #file-input {
            display: none;
        }

        .option-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .option-button {
            background-color: var(--dark-color);
            color: var(--white);
            border: none;
            border-radius: 20px;
            padding: 8px 12px;
            font-size: 13px;
            cursor: pointer;
        }

        .option-button:hover {
            background-color: #054d43;
        }

        @media (min-width: 768px) {
            .message {
                padding: 10px 15px;
                font-size: 15px;
                max-width: 70%;
            }
            
            .chat-container {
                height: 90vh;
                border-radius: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <img src="perfil.webp" alt="Perfil" class="profile-pic" onerror="this.src='https://via.placeholder.com/40'">
            <div class="header-info">
                <h2>Suellen Rocha</h2>
                <p id="status-text">online</p>
            </div>
        </div>

        <div class="chat-messages" id="chat-messages">
            <!-- Messages will be inserted here -->
        </div>

        <div class="pix-upload-area" id="pix-upload-area">
            <div class="preview-container">
                <img id="receipt-preview" style="display: none;">
                <canvas id="pdf-preview" style="display: none;"></canvas>
            </div>
            <p id="ocr-status" class="status-message">Envie seu comprovante</p>
            <div class="upload-buttons">
                <button class="upload-button" id="upload-photo">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"></path>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                        <line x1="12" y1="19" x2="12" y2="23"></line>
                        <line x1="8" y1="23" x2="16" y2="23"></line>
                    </svg>
                    Enviar Foto
                </button>
                <button class="upload-button" id="upload-pdf">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    Enviar PDF
                </button>
            </div>
            <input type="file" id="file-input" accept="image/*,.pdf">
        </div>

        <div class="chat-input-area">
            <button class="attachment-button" id="attach-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                </svg>
            </button>
            <input type="text" class="chat-input" id="chat-input" placeholder="Digite sua mensagem...">
            <button class="send-button" id="send-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
    <script>
        // Configura√ß√£o do PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.worker.min.js';

        // Elementos do DOM
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const attachButton = document.getElementById('attach-button');
        const uploadPhotoButton = document.getElementById('upload-photo');
        const uploadPdfButton = document.getElementById('upload-pdf');
        const fileInput = document.getElementById('file-input');
        const pixUploadArea = document.getElementById('pix-upload-area');
        const receiptPreview = document.getElementById('receipt-preview');
        const pdfPreview = document.getElementById('pdf-preview');
        const ocrStatus = document.getElementById('ocr-status');
        const statusText = document.getElementById('status-text');

        // Vari√°veis de estado
        let chatHistory = [];
        let photosSentCount = 0;
        let expectedPaymentAmount = 0;
        let isWaitingPayment = false;
        let typingIndicator = null;
        let tesseractWorker = null;

        // Valores v√°lidos para PIX
        const validPaymentAmounts = [
            10, 20, 30, 40, 50, 60, 70, 80, 90, 100,
            110, 120, 130, 140, 150, 160, 170, 180, 190, 200
        ];

        // Nomes v√°lidos para PIX
        const validNames = ['antonio', 'renimar', 'pinheiro', 'almeida'];

        // Inicializa√ß√£o
        window.onload = async () => {
            // Sauda√ß√£o inicial
            setTimeout(async () => {
                await addMessageWithDelay("Ol√°, meu bem! Que bom te ver por aqui... üòâ", 'bot');
                await addMessageWithDelay("Eu sou a Suellen Rocha e estou aqui para te oferecer fotos exclusivas!", 'bot');
                await addMessageWithDelay("Quantas fotos voc√™ gostaria de receber? (5, 10, 15, ..., at√© 100)", 'bot');
            }, 1000);

            // Event listeners
            sendButton.addEventListener('click', sendUserMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendUserMessage();
            });

            attachButton.addEventListener('click', () => {
                fileInput.accept = 'image/*,.pdf';
                fileInput.click();
            });

            uploadPhotoButton.addEventListener('click', () => {
                fileInput.accept = 'image/*';
                fileInput.click();
            });

            uploadPdfButton.addEventListener('click', () => {
                fileInput.accept = '.pdf';
                fileInput.click();
            });

            fileInput.addEventListener('change', handleFileUpload);
        };

        // Fun√ß√£o para enviar mensagem do usu√°rio
        function sendUserMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            chatInput.value = '';
            
            // Processar a mensagem do usu√°rio
            processUserMessage(message);
        }

        // Fun√ß√£o para processar a mensagem do usu√°rio
        async function processUserMessage(message) {
            // Verificar se √© uma solicita√ß√£o de quantidade de fotos
            const quantityMatch = message.match(/(\d+)/);
            if (quantityMatch) {
                const requestedQuantity = parseInt(quantityMatch[1]);
                
                if (requestedQuantity >= 5 && requestedQuantity <= 100 && requestedQuantity % 5 === 0) {
                    expectedPaymentAmount = (requestedQuantity / 5) * 10;
                    
                    await addMessageWithDelay(`Perfeito! Para ${requestedQuantity} fotos exclusivas, o valor √© R$${expectedPaymentAmount.toFixed(2)}. üòâ`, 'bot');
                    await addMessageWithDelay(`Minha chave PIX √©: \n\n**98981420070** (CPF)\n\nNome: **Antonio Renimar Pinheiro Almeida**`, 'bot');
                    await addMessageWithDelay(`Envie o comprovante aqui mesmo que eu libero suas fotos! ‚ù§Ô∏è`, 'bot');
                    
                    // Mostrar √°rea de upload
                    showPixUploadArea();
                    return;
                }
            }
            
            // Se n√£o for uma quantidade v√°lida, responder genericamente
            await addMessageWithDelay("Por favor, me diga quantas fotos voc√™ gostaria (5, 10, 15, etc.)", 'bot');
        }

        // Fun√ß√£o para mostrar a √°rea de upload do PIX
        function showPixUploadArea() {
            isWaitingPayment = true;
            pixUploadArea.style.display = 'flex';
            scrollToBottom();
        }

        // Fun√ß√£o para lidar com upload de arquivo
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Resetar previews
            receiptPreview.style.display = 'none';
            pdfPreview.style.display = 'none';

            if (file.type.startsWith('image/')) {
                // Processar imagem
                const reader = new FileReader();
                reader.onload = async (e) => {
                    receiptPreview.src = e.target.result;
                    receiptPreview.style.display = 'block';
                    
                    // Adicionar mensagem com a imagem
                    addMessage('', 'user', true, e.target.result);
                    
                    // Processar OCR
                    await processReceipt(e.target.result, 'image');
                };
                reader.readAsDataURL(file);
            } else if (file.type === 'application/pdf') {
                // Processar PDF
                const arrayBuffer = await file.arrayBuffer();
                
                // Mostrar preview do PDF
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                const page = await pdf.getPage(1);
                const viewport = page.getViewport({ scale: 1.5 });
                
                pdfPreview.height = viewport.height;
                pdfPreview.width = viewport.width;
                
                const renderContext = {
                    canvasContext: pdfPreview.getContext('2d'),
                    viewport: viewport
                };
                
                await page.render(renderContext).promise;
                pdfPreview.style.display = 'block';
                
                // Adicionar mensagem com o PDF
                addMessage('', 'user', false, '', true, arrayBuffer);
                
                // Processar OCR do PDF
                await processReceipt(arrayBuffer, 'pdf');
            }
        }

        // Fun√ß√£o para processar o comprovante (OCR)
        async function processReceipt(fileData, type) {
            ocrStatus.textContent = 'Processando comprovante...';
            ocrStatus.className = 'status-message';
            
            try {
                // Inicializar o Tesseract se necess√°rio
                if (!tesseractWorker) {
                    tesseractWorker = await Tesseract.createWorker('por');
                }
                
                let text = '';
                
                if (type === 'image') {
                    // Processar imagem diretamente
                    const { data: { text: extractedText } } = await tesseractWorker.recognize(fileData);
                    text = extractedText;
                } else if (type === 'pdf') {
                    // Processar PDF p√°gina por p√°gina
                    const pdf = await pdfjsLib.getDocument(fileData).promise;
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const strings = textContent.items.map(item => item.str);
                        text += strings.join(' ') + '\n';
                    }
                }
                
                // Validar o comprovante
                await validateReceipt(text);
                
            } catch (error) {
                console.error('Erro no OCR:', error);
                ocrStatus.textContent = 'Erro ao processar comprovante';
                ocrStatus.className = 'status-message error-message';
                
                await addMessageWithDelay("Ocorreu um erro ao processar seu comprovante. Por favor, tente novamente ou envie uma imagem mais clara.", 'bot');
                showPixUploadArea();
            }
        }

        // Fun√ß√£o para validar o texto do comprovante
        async function validateReceipt(text) {
            ocrStatus.textContent = 'Validando pagamento...';
            
            // Normalizar o texto para compara√ß√£o
            const normalizedText = text.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9\s.,]/g, '');
            
            // Verificar se cont√©m algum dos nomes v√°lidos
            const hasValidName = validNames.some(name => normalizedText.includes(name));
            
            // Extrair todos os valores monet√°rios do texto
            const amountPattern = /(?:r\$\s*|rs\s*)?(\d{1,3}(?:[.,]\d{2})?)/g;
            let extractedAmounts = [];
            let match;
            
            while ((match = amountPattern.exec(normalizedText)) !== null) {
                // Converter para n√∫mero (substituir v√≠rgula por ponto se necess√°rio)
                const amountStr = match[1].replace(',', '.');
                const amount = parseFloat(amountStr);
                extractedAmounts.push(amount);
            }
            
            // Encontrar o valor mais pr√≥ximo do esperado
            let bestMatch = null;
            let smallestDiff = Infinity;
            
            extractedAmounts.forEach(amount => {
                const diff = Math.abs(amount - expectedPaymentAmount);
                if (diff < smallestDiff) {
                    smallestDiff = diff;
                    bestMatch = amount;
                }
            });
            
            // Considerar v√°lido se:
            // 1. Encontrou um nome v√°lido E
            // 2. O valor est√° dentro de uma pequena margem de erro (R$ 0.10)
            const isValid = hasValidName && bestMatch !== null && smallestDiff <= 0.1;
            
            // Simular processamento
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            if (isValid) {
                // Pagamento validado
                ocrStatus.textContent = 'Pagamento confirmado!';
                ocrStatus.className = 'status-message success-message';
                
                pixUploadArea.style.display = 'none';
                isWaitingPayment = false;
                
                await addMessageWithDelay("Pagamento confirmado! Aqui est√£o suas fotos exclusivas üòò", 'bot');
                
                // Enviar as fotos
                await sendPhotos(expectedPaymentAmount);
                
            } else {
                // Pagamento n√£o validado
                ocrStatus.textContent = 'Pagamento n√£o reconhecido';
                ocrStatus.className = 'status-message error-message';
                
                let errorMessage = "N√£o consegui validar seu pagamento. Por favor, verifique:\n\n";
                errorMessage += `- O valor est√° correto? (R$${expectedPaymentAmount.toFixed(2)})\n`;
                errorMessage += "- O comprovante √© para a chave PIX: 98981420070 (CPF)\n";
                errorMessage += "- O nome no comprovante √©: Antonio Renimar Pinheiro Almeida\n\n";
                errorMessage += "Voc√™ pode tentar enviar novamente:";
                
                await addMessageWithDelay(errorMessage, 'bot');
                showPixUploadArea();
            }
        }

        // Fun√ß√£o para enviar as fotos
        async function sendPhotos(amountPaid) {
            const numPhotos = (amountPaid / 10) * 5;
            const photosToSend = Math.min(numPhotos, 100 - photosSentCount);
            
            if (photosToSend <= 0) {
                await addMessageWithDelay("Voc√™ j√° recebeu todas as fotos dispon√≠veis! Obrigada por participar ‚ù§Ô∏è", 'bot');
                return;
            }
            
            for (let i = 0; i < photosToSend; i++) {
                photosSentCount++;
                const photoUrl = `foto${photosSentCount}.webp`;
                
                // Simular digita√ß√£o antes de cada foto
                showTypingIndicator();
                await new Promise(resolve => setTimeout(resolve, 1000));
                hideTypingIndicator();
                
                addMessage('', 'bot', true, photoUrl);
                
                // Pequeno delay entre fotos
                if (i < photosToSend - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            if (photosSentCount >= 100) {
                await addMessageWithDelay("Essas foram todas as fotos dispon√≠veis! Espero que tenha gostado üòò", 'bot');
            } else {
                await addMessageWithDelay(`Voc√™ j√° recebeu ${photosSentCount} fotos. Quer mais alguma coisa?`, 'bot');
            }
        }

        // Fun√ß√µes auxiliares para mensagens
        function addMessage(text, sender, isImage = false, imageUrl = '', isPdf = false, pdfData = null) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${sender}`;
            
            if (isImage) {
                messageElement.innerHTML = `<img src="${imageUrl}" alt="Foto enviada">`;
            } else if (isPdf && pdfData) {
                // Para PDF, j√° mostramos o preview anteriormente
                messageElement.textContent = 'Comprovante em PDF enviado';
            } else {
                messageElement.textContent = text;
            }
            
            chatMessages.appendChild(messageElement);
            scrollToBottom();
        }

        async function addMessageWithDelay(text, sender, delayMs = 1000) {
            showTypingIndicator();
            await new Promise(resolve => setTimeout(resolve, delayMs));
            hideTypingIndicator();
            addMessage(text, sender);
        }

        function showTypingIndicator() {
            if (typingIndicator) return;
            
            typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = '<span></span><span></span><span></span>';
            
            const messageElement = document.createElement('div');
            messageElement.className = 'message bot';
            messageElement.appendChild(typingIndicator);
            
            chatMessages.appendChild(messageElement);
            scrollToBottom();
            
            statusText.textContent = 'digitando...';
        }

        function hideTypingIndicator() {
            if (!typingIndicator) return;
            
            typingIndicator.parentElement.remove();
            typingIndicator = null;
            
            statusText.textContent = 'online';
        }

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    </script>
</body>
</html>
