<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat WhatsApp</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        font-family: 'Segoe UI', sans-serif;
        height: 100%;
        background-color: #ece5dd;
      }
      body {
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .chat-container {
        width: 100%;
        height: 100dvh;
        max-width: 430px;
        background-color: #fff;
        display: flex;
        flex-direction: column;
        box-shadow: 0 0 10px rgba(0,0,0,0.2);
        position: relative;
      }
      .chat-header {
        background-color: #075E54;
        padding: 10px 15px;
        display: flex;
        align-items: center;
        color: white;
      }
      .chat-header img {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        margin-right: 12px;
        object-fit: cover;
      }
      .chat-header .name {
        font-size: 18px;
        font-weight: bold;
      }
      .chat-body {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        background-color: #e5ddd5;
        display: flex;
        flex-direction: column;
      }
      .message {
        max-width: 75%;
        padding: 10px 14px;
        margin-bottom: 8px;
        font-size: 15px;
        border-radius: 8px;
        line-height: 1.4;
        word-wrap: break-word;
      }
      .user {
        align-self: flex-end;
        background-color: #dcf8c6;
        border-bottom-right-radius: 0;
      }
      .bot {
        align-self: flex-start;
        background-color: white;
        border-bottom-left-radius: 0;
      }
      .typing-indicator {
        align-self: flex-start;
        background-color: white;
        border-bottom-left-radius: 0;
        max-width: 50px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        margin-bottom: 8px;
        padding: 5px 10px;
      }
      .typing-indicator span {
        display: inline-block;
        width: 6px;
        height: 6px;
        margin: 0 1px;
        background-color: #999;
        border-radius: 50%;
        animation: blink 1.4s infinite both;
      }
      .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
      }
      .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
      }
      @keyframes blink {
        0%, 80%, 100% { opacity: 0; }
        40% { opacity: 1; }
      }
      .chat-footer {
        display: flex;
        padding: 8px 10px;
        background-color: #fff;
        border-top: 1px solid #ccc;
        align-items: center;
        position: relative;
      }
      .chat-footer input {
        flex: 1;
        padding: 12px;
        border: none;
        font-size: 16px;
        border-radius: 20px;
        margin-right: 8px;
        background-color: #f0f0f0;
        outline: none;
        padding-left: 40px;
      }
      .chat-footer button#actionButton {
        width: 40px;
        height: 40px;
        background-color: #1bac5f;
        border: none;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .chat-footer button#actionButton img {
        width: 20px;
        height: 20px;
      }
      .option-buttons {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        flex-wrap: wrap;
      }
      .option-button {
        background-color: #075E54;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
      }
      .option-button:hover {
        background-color: #0b7a67;
      }
      .preview-image {
        max-width: 100%;
        border-radius: 8px;
        margin-top: 10px;
      }
      .upload-label {
        display: inline-flex;
        align-items: center;
        padding: 8px 12px;
        background-color: #075E54;
        color: white;
        border-radius: 20px;
        cursor: pointer;
        margin-top: 10px;
        margin-right: 10px;
        font-size: 14px;
        gap: 6px;
      }
      .upload-label img {
        width: 16px;
        height: 16px;
      }
      #uploadComprovanteFoto, #uploadComprovantePDF {
        display: none;
      }
      .pix-info {
        background-color: #f0f0f0;
        padding: 15px;
        border-radius: 10px;
        margin-top: 15px;
      }
      .pix-info p {
        margin: 5px 0;
      }
      .pix-info strong {
        color: #075E54;
      }
      .comprovante-container {
        margin-top: 15px;
      }
      .comprovante-preview {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        margin-top: 10px;
        border: 1px solid #ccc;
      }
      .success-message {
        color: #25D366;
        font-weight: bold;
        margin-top: 10px;
      }
      .error-message {
        color: #f44336;
        font-weight: bold;
        margin-top: 10px;
      }
      .pdf-warning {
        background-color: #fff3cd;
        color: #856404;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        font-size: 14px;
      }
      .upload-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }
    </style>
</head>
<body>
    <div class="chat-container">
      <div class="chat-header">
        <img src="perfil.webp" alt="Perfil">
        <div class="name"><strong>Suellen Rocha</strong></div>
      </div>
      <div class="chat-body" id="chatBody"></div>
      <div class="chat-footer">
        <input type="text" id="userInput" placeholder="Digite sua mensagem..." onkeypress="handleKeyPress(event)">
        <button id="actionButton" title="Enviar">
          <img id="actionIcon" src="mensagem.webp" alt="√çcone">
        </button>
      </div>
    </div>

    <script>
      // Configura√ß√£o do PDF.js
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.worker.min.js';
      
      const PIX_KEY = '98981420070';
      const RECEIVER_NAME = 'Antonio Renimar Pinheiro Almeida';
      const RECEIVER_KEYWORDS = ['antonio', 'renimar', 'pinheiro', 'almeida'];
      
      let isWaitingResponse = false;
      let typingEl = null;
      let isWaitingPayment = false;
      let uploadedComprovante = null;
      let comprovanteUploaded = false;
      let expectedAmount = 0;

      // Valores v√°lidos para os pacotes de fotos (R$10 para cada 5 fotos)
      const validAmounts = [10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 110, 120, 130, 140, 150, 160, 170, 180, 190, 200];

      window.onload = async () => {
        // Mensagem inicial ap√≥s 3 segundos
        setTimeout(async () => {
          await simulateTyping("Oi√™, meu bem! Que bom te ver por aqui... üôà");
        }, 3000);
      };

      function appendMessage(sender, message) {
        const chatBody = document.getElementById("chatBody");
        const msgEl = document.createElement("div");
        msgEl.className = `message ${sender}`;
        msgEl.innerHTML = message;
        chatBody.appendChild(msgEl);
        chatBody.scrollTop = chatBody.scrollHeight;
      }

      function showTypingIndicator() {
        if (!typingEl) {
          typingEl = document.createElement("div");
          typingEl.className = "typing-indicator";
          typingEl.innerHTML = "<span></span><span></span><span></span>";
          document.getElementById("chatBody").appendChild(typingEl);
          document.getElementById("chatBody").scrollTop = document.getElementById("chatBody").scrollHeight;
        }
      }

      function hideTypingIndicator() {
        if (typingEl) {
          typingEl.remove();
          typingEl = null;
        }
      }

      async function simulateTyping(message, delay = 4000) {
        // 3 segundos sem aparecer nada
        await new Promise(r => setTimeout(r, 3000));
        
        // Mostra o indicador de digita√ß√£o por 4 segundos
        showTypingIndicator();
        await new Promise(r => setTimeout(r, 4000));
        hideTypingIndicator();
        
        if (message) {
          appendMessage("bot", message);
        }
      }

      function handleKeyPress(event) {
        if (event.key === 'Enter' && !isWaitingResponse) {
          sendMessage();
        }
      }

      async function sendMessage() {
        if (isWaitingResponse) return;
        const text = userInput.value.trim();
        if (!text) return;
        
        appendMessage("user", text);
        userInput.value = "";
        isWaitingResponse = true;
        showTypingIndicator();

        const lower = text.toLowerCase();
        const normalized = lower.normalize('NFD').replace(/[\u0300-\u036f]/g, '');

        // Verifica se a mensagem cont√©m um n√∫mero de fotos solicitado
        const quantityMatch = text.match(/(\d+)\s*(fotos|foto)/i) || 
                             text.match(/(cinco|dez|quinze|vinte|vinte e cinco|trinta|trinta e cinco|quarenta|quarenta e cinco|cinquenta|cinquenta e cinco|sessenta|sessenta e cinco|setenta|setenta e cinco|oitenta|oitenta e cinco|noventa|noventa e cinco|cem)/i);
        
        if (quantityMatch) {
          let requestedQuantity = 0;
          const numText = quantityMatch[1] ? quantityMatch[1].toLowerCase() : quantityMatch[0].toLowerCase();
          
          switch (numText) {
            case 'cinco': requestedQuantity = 5; break;
            case 'dez': requestedQuantity = 10; break;
            case 'quinze': requestedQuantity = 15; break;
            case 'vinte': requestedQuantity = 20; break;
            case 'vinte e cinco': requestedQuantity = 25; break;
            case 'trinta': requestedQuantity = 30; break;
            case 'trinta e cinco': requestedQuantity = 35; break;
            case 'quarenta': requestedQuantity = 40; break;
            case 'quarenta e cinco': requestedQuantity = 45; break;
            case 'cinquenta': requestedQuantity = 50; break;
            case 'cinquenta e cinco': requestedQuantity = 55; break;
            case 'sessenta': requestedQuantity = 60; break;
            case 'sessenta e cinco': requestedQuantity = 65; break;
            case 'setenta': requestedQuantity = 70; break;
            case 'setenta e cinco': requestedQuantity = 75; break;
            case 'oitenta': requestedQuantity = 80; break;
            case 'oitenta e cinco': requestedQuantity = 85; break;
            case 'noventa': requestedQuantity = 90; break;
            case 'noventa e cinco': requestedQuantity = 95; break;
            case 'cem': requestedQuantity = 100; break;
            default: requestedQuantity = parseInt(numText); break;
          }

          if (requestedQuantity >= 5 && requestedQuantity <= 100 && requestedQuantity % 5 === 0) {
            expectedAmount = (requestedQuantity / 5) * 10;
            
            // Mostra as mensagens de pagamento
            await simulateTyping(`Perfeito! Para ${requestedQuantity} fotinhas exclusivas, o valor √© R$${expectedAmount.toFixed(2).replace('.', ',')}. üòâ`);
            await simulateTyping(`Minha chave PIX √©: <strong>${PIX_KEY}</strong>`);
            await simulateTyping(`Meu assessor vai confirmar o pagamento e te enviar tudinho! ‚ù§Ô∏èü§§`);
            
            // Mostra op√ß√µes para enviar comprovante
            showPaymentOptions();
          } else {
            await simulateTyping("Hmm... os pacotes s√£o de 5 em 5 fotos, amor. Pode escolher 5, 10, 15, 20... at√© 100? üíã");
          }
        } else {
          // Resposta padr√£o para outras mensagens
          await simulateTyping("Quantas fotos voc√™ gostaria, meu bem? Os pacotes s√£o de 5 em 5 fotos. üòâ");
        }
        
        isWaitingResponse = false;
      }

      async function showPaymentOptions() {
        isWaitingPayment = true;
        comprovanteUploaded = false;
        
        const pixInfoHTML = `
          <div class="pix-info">
            <p><strong>üìå Chave Pix (CPF):</strong> ${PIX_KEY}</p>
            <p><strong>üìå Nome:</strong> ${RECEIVER_NAME}</p>
            <p><strong>üí∞ Valor:</strong> R$ ${expectedAmount.toFixed(2).replace('.', ',')}</p>
            <div class="pdf-warning">
              <strong>üìÑ Aten√ß√£o:</strong> Voc√™ pode enviar o comprovante em imagem (JPG/PNG) ou em PDF.
            </div>
          </div>
          <div class="comprovante-container">
            <div class="upload-buttons">
              <label for="uploadComprovanteFoto" class="upload-label">
                <img src="camera.webp" alt="Enviar imagem" />
                Enviar Comprovante em Foto
              </label>
              <label for="uploadComprovantePDF" class="upload-label">
                <img src="pdf-icon.webp" alt="Enviar PDF" />
                Enviar Comprovante em PDF
              </label>
            </div>
            <input type="file" accept="image/*" id="uploadComprovanteFoto" style="display: none" />
            <input type="file" accept=".pdf" id="uploadComprovantePDF" style="display: none" />
          </div>
        `;
        
        appendMessage("bot", pixInfoHTML);
        
        // Configurar os listeners para os uploads
        document.getElementById('uploadComprovanteFoto').addEventListener('change', function(e) {
          if (!comprovanteUploaded) {
            handleComprovanteUpload(e, 'image');
            comprovanteUploaded = true;
          }
        });
        
        document.getElementById('uploadComprovantePDF').addEventListener('change', function(e) {
          if (!comprovanteUploaded) {
            handleComprovanteUpload(e, 'pdf');
            comprovanteUploaded = true;
          }
        });
      }

      async function handleComprovanteUpload(event, type) {
        const file = event.target.files[0];
        if (!file) return;
        
        try {
          if (type === 'pdf') {
            // Processar PDF primeiro para mostrar o comprovante
            await processPDFComprovante(file);
          } else {
            // Processar imagem primeiro para mostrar o comprovante
            await processImageComprovante(file);
          }
          
          // Mostra mensagem de valida√ß√£o
          appendMessage("bot", "üîÑ S√≥ um momento‚Ä¶ Estou validando seu pagamento. üòâ");
          
          showTypingIndicator();
          
          // Agora fazer a valida√ß√£o
          if (type === 'pdf') {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            let extractedText = '';
            
            for (let i = 1; i <= pdf.numPages; i++) {
              const page = await pdf.getPage(i);
              const textContent = await page.getTextContent();
              const strings = textContent.items.map(item => item.str);
              extractedText += strings.join(' ') + '\n';
            }
            
            await verifyComprovanteText(extractedText);
          } else {
            const reader = new FileReader();
            const imageData = await new Promise((resolve, reject) => {
              reader.onload = e => resolve(e.target.result);
              reader.onerror = reject;
              reader.readAsDataURL(file);
            });
            await verifyComprovante(imageData);
          }
        } catch (error) {
          console.error("Erro ao processar comprovante:", error);
          hideTypingIndicator();
          showComprovanteError();
        }
      }

      async function processImageComprovante(file) {
        const reader = new FileReader();
        return new Promise((resolve, reject) => {
          reader.onload = function(e) {
            uploadedComprovante = e.target.result;
            const previewHTML = `
              <div class="comprovante-container">
                <p>Comprovante enviado (imagem):</p>
                <img src="${uploadedComprovante}" class="comprovante-preview">
              </div>
            `;
            appendMessage("user", previewHTML);
            resolve();
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      async function processPDFComprovante(file) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
        
        // Criar uma imagem da primeira p√°gina para mostrar como preview
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({ scale: 1.0 });
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        
        await page.render({
          canvasContext: context,
          viewport: viewport
        }).promise;
        
        const previewImage = canvas.toDataURL('image/jpeg');
        uploadedComprovante = previewImage;
        
        // Mostrar preview do PDF
        const previewHTML = `
          <div class="comprovante-container">
            <p>Comprovante enviado (PDF):</p>
            <img src="${previewImage}" class="comprovante-preview">
          </div>
        `;
        appendMessage("user", previewHTML);
      }

      async function verifyComprovante(imageData) {
        try {
          const { data: { text } } = await Tesseract.recognize(
            imageData,
            'por',
            { logger: m => console.log(m) }
          );
          
          await verifyComprovanteText(text);
        } catch (error) {
          console.error("Erro ao verificar comprovante:", error);
          throw error;
        }
      }

      async function verifyComprovanteText(text) {
        hideTypingIndicator();
        
        // Normaliza o texto para facilitar a busca
        const normalizedText = text.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        
        // Verifica se o texto cont√©m qualquer uma das palavras-chave do nome do recebedor
        const hasReceiverName = RECEIVER_KEYWORDS.some(keyword => normalizedText.includes(keyword));
        
        // Verifica se o texto cont√©m o valor esperado
        let hasCorrectAmount = false;
        const amountPattern = /(?:r\$\s*|rs\s*)?(\d{1,3}(?:[.,]\d{2})?)/g;
        let match;
        
        while ((match = amountPattern.exec(normalizedText)) !== null) {
          const amountStr = match[1].replace(',', '.');
          const currentAmount = parseFloat(amountStr);
          
          // Verifica se o valor encontrado est√° na lista de valores v√°lidos
          if (validAmounts.includes(currentAmount) && currentAmount === expectedAmount) {
            hasCorrectAmount = true;
            break;
          }
        }
        
        if (hasReceiverName && hasCorrectAmount) {
          // Mostrar mensagem de sucesso
          const successHTML = `
            <div class="success-message">
              ‚úÖ Pagamento confirmado! Obrigada, meu bem! üòò
            </div>
            <p>Seu pacote com ${expectedAmount / 10 * 5} fotos exclusivas est√° sendo enviado...</p>
          `;
          appendMessage("bot", successHTML);
          
          // Simular envio das fotos
          await sendPhotos(expectedAmount);
        } else {
          showComprovanteError();
        }
      }

      async function sendPhotos(amount) {
        const numPhotos = amount / 10 * 5;
        
        for (let i = 1; i <= numPhotos; i++) {
          if (i > 100) break; // Limite de 100 fotos
          
          await simulateTyping("", 2000);
          appendMessage("bot", `<img src="foto${i}.webp" class="preview-image">`);
          
          // Pequeno delay entre fotos
          if (i < numPhotos) {
            await new Promise(r => setTimeout(r, 1500));
          }
        }
        
        if (numPhotos >= 100) {
          await simulateTyping("Acabou por hoje, meu bem. Mas fica por perto... logo logo eu volto com mais surpresas üî•");
        } else {
          await simulateTyping("Espero que tenha gostado das fotos, amor! Se quiser mais √© s√≥ me chamar üòâ");
        }
      }

      function showComprovanteError() {
        let errorMessage = '<div class="error-message">‚ùå N√£o consegui confirmar seu pagamento</div>';
        errorMessage += '<p>Por favor, verifique se:</p>';
        errorMessage += '<ul>';
        errorMessage += `<li>Voc√™ enviou o comprovante do Pix para a chave <strong>${PIX_KEY}</strong> (CPF)</li>`;
        errorMessage += `<li>O valor est√° correto: <strong>R$ ${expectedAmount.toFixed(2).replace('.', ',')}</strong></li>`;
        errorMessage += '</ul>';
        errorMessage += '<p>Se j√° conferiu tudo e ainda assim n√£o foi validado, pode enviar novamente o comprovante?</p>';
        errorMessage += `
          <div class="comprovante-container">
            <div class="upload-buttons">
              <label for="uploadComprovanteFoto" class="upload-label">
                <img src="camera.webp" alt="Enviar imagem" />
                Enviar Comprovante em Foto
              </label>
              <label for="uploadComprovantePDF" class="upload-label">
                <img src="pdf-icon.webp" alt="Enviar PDF" />
                Enviar Comprovante em PDF
              </label>
            </div>
            <input type="file" accept="image/*" id="uploadComprovanteFoto" style="display: none" />
            <input type="file" accept=".pdf" id="uploadComprovantePDF" style="display: none" />
          </div>
        `;
        
        appendMessage("bot", errorMessage);
        
        // Configurar novamente os listeners
        comprovanteUploaded = false;
        document.getElementById('uploadComprovanteFoto').addEventListener('change', function(e) {
          if (!comprovanteUploaded) {
            handleComprovanteUpload(e, 'image');
            comprovanteUploaded = true;
          }
        });
        
        document.getElementById('uploadComprovantePDF').addEventListener('change', function(e) {
          if (!comprovanteUploaded) {
            handleComprovanteUpload(e, 'pdf');
            comprovanteUploaded = true;
          }
        });
      }
    </script>
</body>
</html>
